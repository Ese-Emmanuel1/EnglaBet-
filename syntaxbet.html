<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyntaxBet - Word Formation Challenge</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <style>
        :root {
            --primary: #0a2e5a;
            --secondary: #1a4789;
            --accent: #4cc9f0;
            --accent-gradient: linear-gradient(to right, #4cc9f0, #4895ef);
            --text-light: #ffffff;
            --text-gray: #a0c1ed;
            --card-bg: #1a3e75;
            --card-dark: #0f2b50;
            --success: #4cc9f0;
            --warning: #f8961e;
            --danger: #e63946;
            --border-radius: 12px;
            --box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--text-light);
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
            font-size: 12px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        header {
            text-align: center;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            animation: fadeIn 0.8s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
        }

        h1 {
            color: var(--text-light);
            font-size: 1.6rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        h1 i {
            color: var(--accent);
            font-size: 1.4rem;
        }

        .subtitle {
            color: var(--text-gray);
            font-size: 0.8rem;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.4;
        }

        .header-buttons {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 8px;
        }

        .header-btn {
            padding: 6px 10px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: var(--text-light);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
            font-size: 0.7rem;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .game-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        @media (max-width: 900px) {
            .game-area {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .header-buttons {
                position: static;
                justify-content: center;
                margin-top: 10px;
            }
        }

        .panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 15px;
            animation: slideUp 0.5s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .panel-title {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-light);
            font-size: 1rem;
        }

        .panel-title i {
            font-size: 0.9rem;
            color: var(--accent);
        }

        .topic-box {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-family: monospace;
            white-space: pre-wrap;
            line-height: 1.4;
            max-height: 200px;
            overflow-y: auto;
            position: relative;
            font-size: 0.8rem;
        }

        .corrections-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--accent-gradient);
            color: var(--primary);
            border: none;
            border-radius: 4px;
            padding: 5px 8px;
            font-size: 0.6rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 3px 10px rgba(76, 201, 240, 0.4);
        }

        .corrections-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 201, 240, 0.6);
        }

        .betting-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        /* STAKE ENTRY BOX - UPDATED STYLES */
        .stake-entry-container {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 10px;
        }

        .stake-entry-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            color: var(--accent);
        }

        .stake-entry-header i {
            font-size: 1rem;
        }

        .stake-entry-header h3 {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .stake-amount-display {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }

        .stake-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .stake-input-group label {
            min-width: 80px;
            font-size: 0.75rem;
            color: var(--text-gray);
            font-weight: 500;
        }

        .stake-amount-input {
            flex: 1;
            padding: 8px 12px;
            border-radius: 6px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            font-size: 0.9rem;
            font-weight: 600;
            transition: var(--transition);
        }

        .stake-amount-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(76, 201, 240, 0.2);
        }

        .stake-amount-input.invalid {
            border-color: var(--danger);
            background: rgba(230, 57, 70, 0.1);
        }

        .stake-amount-input.valid {
            border-color: var(--success);
            background: rgba(76, 201, 240, 0.1);
        }

        .stake-range-info {
            font-size: 0.7rem;
            color: var(--text-gray);
            padding: 6px 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            margin-top: 4px;
        }

        .stake-preview {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 12px;
            margin-top: 10px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .stake-preview-item {
            display: flex;
            flex-direction: column;
        }

        .stake-preview-label {
            font-size: 0.65rem;
            color: var(--text-gray);
            margin-bottom: 2px;
        }

        .stake-preview-value {
            font-size: 0.85rem;
            font-weight: 700;
        }

        .stake-preview-value.min-win {
            color: var(--accent);
        }

        .stake-preview-value.max-win {
            color: var(--success);
        }

        /* Updated word buttons - Smaller icons */
        .word-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px; /* Reduced gap */
            margin-top: 10px;
        }

        @media (max-width: 600px) {
            .word-buttons {
                grid-template-columns: repeat(4, 1fr);
                gap: 3px; /* Even smaller gap on mobile */
            }
        }

        .word-btn {
            padding: 5px 3px; /* Reduced padding */
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            background: var(--card-bg);
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 35px; /* Reduced height */
            font-size: 0.7rem; /* Smaller font */
        }

        .word-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .word-btn.active {
            background: var(--accent-gradient);
            color: var(--primary);
            box-shadow: 0 5px 15px rgba(76, 201, 240, 0.4);
        }

        .word-btn .btn-label {
            font-size: 0.65rem; /* Smaller label */
            font-weight: bold;
        }

        .word-btn .btn-payout {
            font-size: 0.55rem; /* Smaller payout text */
            opacity: 0.8;
        }

        .place-bet-btn {
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            background: var(--accent-gradient);
            color: var(--primary);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
            box-shadow: 0 5px 15px rgba(76, 201, 240, 0.4);
            width: 100%;
        }

        .place-bet-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 201, 240, 0.6);
        }

        .place-bet-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Sentence area styling */
        .sentence-area {
            min-height: 80px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            border: 2px dashed rgba(255, 255, 255, 0.2);
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }

        .sentence-word {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--accent);
            padding: 6px 10px;
            border-radius: 4px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            animation: popIn 0.3s ease;
            box-shadow: 0 3px 10px rgba(76, 201, 240, 0.1);
            color: var(--text-light);
            font-size: 0.8rem;
        }

        .controls {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        button {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.7rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(10, 46, 90, 0.3);
        }

        .btn-secondary {
            background: var(--accent);
            color: var(--primary);
        }

        .btn-secondary:hover {
            background: #3ab0d9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 201, 240, 0.3);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #3ab0d9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 201, 240, 0.3);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(230, 57, 70, 0.3);
        }

        .ai-response {
            background: rgba(255, 255, 255, 0.1);
            border-left: 3px solid var(--accent);
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            display: none;
            animation: slideIn 0.5s ease;
            font-size: 0.8rem;
        }

        .ai-response.show {
            display: block;
        }

        .ai-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            color: var(--accent);
            font-size: 0.9rem;
        }

        .ai-header i {
            font-size: 1.1rem;
        }

        .score-display {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            flex-wrap: wrap;
            gap: 10px;
        }

        .score-item {
            text-align: center;
            flex: 1;
            min-width: 70px;
        }

        .score-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--accent);
        }

        .score-label {
            font-size: 0.7rem;
            color: var(--text-gray);
        }

        .examples {
            margin-top: 15px;
        }

        .examples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .example {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid var(--accent);
            font-size: 0.7rem;
        }

        .rules {
            margin-top: 15px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 0.8rem;
        }

        .rules ul {
            padding-left: 15px;
            margin-top: 8px;
        }

        .rules li {
            margin-bottom: 6px;
            line-height: 1.4;
        }

        footer {
            text-align: center;
            margin-top: 25px;
            padding: 15px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.7rem;
        }

        /* Timer Styles */
        .timer-container {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
        }

        .timer {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 30px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .timer.running {
            color: var(--accent);
            border-color: var(--accent);
        }

        .timer.warning {
            color: var(--warning);
            border-color: var(--warning);
            animation: pulse 1s infinite;
        }

        .timer.danger {
            color: var(--danger);
            border-color: var(--danger);
            animation: pulse 0.5s infinite;
        }

        /* Overlay Styles */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .overlay-content {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: var(--border-radius);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
            position: relative;
            transform: translateY(20px);
            transition: var(--transition);
            font-size: 0.8rem;
        }

        .overlay.active .overlay-content {
            transform: translateY(0);
        }

        .overlay-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .overlay-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .overlay-title {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.2rem;
        }

        .overlay-title i {
            color: var(--accent);
        }

        .help-examples {
            margin-bottom: 15px;
        }

        .help-examples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .help-example {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid var(--accent);
            font-size: 0.7rem;
        }

        .help-rules {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }

        .help-rules ul {
            padding-left: 15px;
            margin-top: 8px;
        }

        .help-rules li {
            margin-bottom: 6px;
            line-height: 1.4;
        }

        /* Records Button */
        .records-btn {
            margin-top: 15px;
            padding: 8px 12px;
            background: var(--accent-gradient);
            color: var(--primary);
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: 0 5px 15px rgba(76, 201, 240, 0.4);
            width: 100%;
            font-size: 0.8rem;
        }

        .records-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 201, 240, 0.6);
        }

        /* Game Records Styles */
        .records-container {
            margin-top: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .records-title {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            color: var(--accent);
            font-size: 0.9rem;
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.7rem;
        }

        .records-table th {
            text-align: left;
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-gray);
        }

        .records-table td {
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .records-table tr:last-child td {
            border-bottom: none;
        }

        .win-amount {
            color: var(--success);
            font-weight: bold;
        }

        .loss-amount {
            color: var(--danger);
            font-weight: bold;
        }

        .status {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.6rem;
            font-weight: 600;
        }

        .status.won {
            background: rgba(76, 222, 128, 0.2);
            color: #4ade80;
        }

        .status.lost {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        /* Records Modal Styles */
        .records-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .records-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .records-modal-content {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: var(--border-radius);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 25px;
            position: relative;
            transform: translateY(20px);
            transition: var(--transition);
            font-size: 0.8rem;
        }

        .records-modal.active .records-modal-content {
            transform: translateY(0);
        }

        .records-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .records-modal-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
            color: var(--text-light);
        }

        .records-modal-title i {
            color: var(--accent);
        }

        .records-modal-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            cursor: pointer;
            transition: var(--transition);
            font-size: 1rem;
        }

        .records-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .records-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .record-stat {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .record-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 5px;
        }

        .record-stat-label {
            font-size: 0.7rem;
            color: var(--text-gray);
        }

        .records-table-container {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
        }

        .records-table-modal {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }

        .records-table-modal th {
            text-align: left;
            padding: 12px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-gray);
            font-weight: 600;
            position: sticky;
            top: 0;
            background: rgba(26, 62, 117, 0.9);
            backdrop-filter: blur(10px);
        }

        .records-table-modal td {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .records-table-modal tr:last-child td {
            border-bottom: none;
        }

        .records-table-modal tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* NEW: Stake Display Styles */
        .stake-display {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            display: none;
            animation: slideIn 0.5s ease;
        }

        .stake-display.show {
            display: block;
        }

        .stake-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            color: var(--accent);
            font-size: 0.9rem;
        }

        .stake-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .stake-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stake-label {
            color: var(--text-gray);
            font-size: 0.7rem;
        }

        .stake-value {
            font-weight: bold;
            font-size: 0.8rem;
        }

        .stake-value.positive {
            color: var(--success);
        }

        .stake-value.negative {
            color: var(--danger);
        }

        /* User Info Styles */
        .user-info {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            font-size: 0.75rem;
        }

        .user-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            object-fit: cover;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: var(--text-light);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
            font-size: 0.7rem;
            padding: 6px 10px;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        /* NEW: Numbers Page Styles */
        .numbers-page-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            padding: 15px;
        }

        .numbers-page-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .numbers-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .numbers-header-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
        }

        .numbers-header-title i {
            color: var(--accent);
        }

        .close-numbers-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: var(--text-light);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
            font-size: 0.7rem;
            padding: 8px 12px;
        }

        .close-numbers-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .numbers-grid-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Updated grid with smaller icons */
        .numbers-grid-full {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 6px; /* Reduced gap */
        }

        .number-full {
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            height: 40px; /* Reduced height */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem; /* Smaller font */
            cursor: pointer;
            transition: var(--transition);
            user-select: none;
            color: var(--text-light);
            position: relative;
            overflow: hidden;
            padding: 2px; /* Reduced padding */
        }

        .number-full:hover {
            transform: translateY(-2px);
            border-color: var(--accent);
            box-shadow: 0 5px 15px rgba(76, 201, 240, 0.2);
        }

        .number-full.selected {
            background: var(--accent-gradient);
            color: var(--primary);
            border-color: var(--accent);
        }

        .number-full.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .number-label {
            font-size: 0.65rem; /* Smaller label */
            opacity: 0.8;
            margin-top: 1px;
        }

        .number-word {
            font-size: 0.55rem; /* Smaller word text */
            font-weight: normal;
            color: var(--text-gray);
            margin-top: 1px;
            max-width: 90%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: none; /* HIDE THE WORDS */
        }

        .numbers-footer {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            70% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 201, 240, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(76, 201, 240, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 201, 240, 0); }
        }

        .notification {
            position: fixed;
            top: 15px;
            right: 15px;
            padding: 10px 15px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.5s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            max-width: 250px;
            font-size: 0.7rem;
        }

        .notification.success {
            background: var(--success);
        }

        .notification.error {
            background: var(--danger);
        }

        .notification.info {
            background: var(--accent);
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Mobile-specific adjustments */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.4rem;
            }
            
            .subtitle {
                font-size: 0.7rem;
            }
            
            .panel {
                padding: 12px;
            }
            
            button {
                padding: 6px 10px;
                font-size: 0.65rem;
            }
            
            .controls {
                gap: 6px;
            }
            
            .score-item {
                min-width: 60px;
            }
            
            .score-value {
                font-size: 1rem;
            }
            
            .overlay-content {
                padding: 15px;
            }
            
            .records-stats {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .records-modal-content {
                padding: 15px;
            }
            
            .stake-details {
                grid-template-columns: 1fr;
            }
            
            /* Stake entry box mobile adjustments */
            .stake-preview {
                grid-template-columns: 1fr;
            }
            
            .stake-input-group {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .stake-input-group label {
                margin-bottom: 4px;
            }
            
            /* Numbers page mobile adjustments */
            .numbers-grid-full {
                grid-template-columns: repeat(5, 1fr);
                gap: 5px; /* Even smaller gap */
            }
            
            .number-full {
                height: 35px; /* Smaller on mobile */
                font-size: 0.75rem;
            }
            
            .number-word {
                font-size: 0.5rem; /* Even smaller on mobile */
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 8px;
            }
            
            header {
                padding: 12px 8px;
            }
            
            h1 {
                font-size: 1.2rem;
            }
            
            .game-area {
                gap: 12px;
            }
            
            .controls {
                flex-direction: column;
            }
            
            button {
                width: 100%;
                justify-content: center;
            }
            
            .numbers-grid-full {
                grid-template-columns: repeat(4, 1fr);
                gap: 4px; /* Smallest gap */
            }
            
            .number-full {
                height: 32px; /* Smallest height */
                font-size: 0.7rem;
            }
            
            .stake-entry-container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Modal -->
    <div id="auth-modal" class="overlay" style="display: none;">
        <div class="overlay-content" style="max-width: 400px;">
            <h2 class="overlay-title"><i class="fas fa-gamepad"></i> Welcome to SyntaxBet</h2>
            
            <div id="auth-error" style="display: none; background: rgba(230, 57, 70, 0.2); color: var(--danger); padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 0.8rem;"></div>
            
            <div id="login-form">
                <div style="margin-bottom: 15px;">
                    <input type="email" id="login-email" class="stake-amount-input" placeholder="Email address" style="width: 100%; margin-bottom: 10px;">
                    <input type="password" id="login-password" class="stake-amount-input" placeholder="Password" style="width: 100%;">
                </div>
                <button id="login-submit" class="place-bet-btn" style="margin-top: 0;">
                    <i class="fas fa-sign-in-alt"></i> Sign In
                </button>
                <button id="show-register" class="records-btn" style="margin-top: 10px;">
                    <i class="fas fa-user-plus"></i> Create Account
                </button>
            </div>
            
            <div id="register-form" style="display: none;">
                <div style="margin-bottom: 15px;">
                    <input type="email" id="register-email" class="stake-amount-input" placeholder="Email address" style="width: 100%; margin-bottom: 10px;">
                    <input type="password" id="register-password" class="stake-amount-input" placeholder="Password (min 6 characters)" style="width: 100%; margin-bottom: 10px;">
                    <input type="text" id="register-fullname" class="stake-amount-input" placeholder="Full Name" style="width: 100%;">
                </div>
                <button id="register-submit" class="place-bet-btn" style="margin-top: 0;">
                    <i class="fas fa-user-plus"></i> Create Account
                </button>
                <button id="show-login" class="records-btn" style="margin-top: 10px;">
                    <i class="fas fa-sign-in-alt"></i> Back to Login
                </button>
            </div>
            
            <div id="auth-loading" style="display: none; text-align: center; padding: 20px;">
                <div class="loading" style="margin: 0 auto 10px;"></div>
                <p>Authenticating...</p>
            </div>
            
            <div style="margin-top: 20px; font-size: 0.7rem; opacity: 0.8; text-align: center;">
                <p>By continuing, you agree to our Terms of Service and Privacy Policy</p>
            </div>
        </div>
    </div>

    <div class="container" id="game-container" style="display: none;">
        <header>
            <h1><i class="fas fa-water"></i> SYNTAXBET</h1>
            <p class="subtitle">Form meaningful phrases, clauses, or sentences by selecting words in the rightward order. Challenge your syntax skills with our AI-powered evaluation system.</p>
            
            <div class="header-buttons">
                <div class="user-info" id="user-info" style="display: none;">
                    <img src="" alt="User Avatar" class="user-avatar" id="user-avatar">
                    <span id="user-name">Guest</span>
                </div>
                <button class="logout-btn" id="logout-btn" style="display: none;">
                    <i class="fas fa-right-from-bracket"></i> Logout
                </button>
                <button class="header-btn" id="helpBtn">
                    <i class="fas fa-question-circle"></i> Help
                </button>
                <button class="header-btn" id="correctionsBtn">
                    <i class="fas fa-edit"></i> Corrections
                </button>
            </div>
        </header>

        <div class="timer-container">
            <div class="timer" id="timer">
                <i class="fas fa-clock"></i>
                <span id="timerValue">02:00</span>
            </div>
        </div>

        <div class="game-area">
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-comments"></i> Topic & Betting</h2>
                
                <div class="topic-box" id="topicBox">
                    Loading topic...
                </div>

                <!-- STAKE ENTRY BOX - UPDATED -->
                <div class="stake-entry-container">
                    <div class="stake-entry-header">
                        <i class="fas fa-coins"></i>
                        <h3>Stake Entry</h3>
                    </div>
                    
                    <div class="stake-amount-display">
                        <div class="stake-input-group">
                            <label>Stake Amount:</label>
                            <input type="number" class="stake-amount-input" id="stakeAmountInput" 
                                   placeholder="Enter stake amount" min="0.2" step="0.1" value="">
                        </div>
                        <div class="stake-range-info" id="stakeRangeInfo">
                            W3: $5-$200 | W4-W10: $0.2-$200
                        </div>
                    </div>
                    
                    <div class="stake-preview" id="stakePreview" style="display: none;">
                        <div class="stake-preview-item">
                            <span class="stake-preview-label">Selected Word Length:</span>
                            <span class="stake-preview-value" id="previewWordLength">W3</span>
                        </div>
                        <div class="stake-preview-item">
                            <span class="stake-preview-label">Stake Amount:</span>
                            <span class="stake-preview-value" id="previewStakeAmount">$0</span>
                        </div>
                        <div class="stake-preview-item">
                            <span class="stake-preview-label">Min Winning:</span>
                            <span class="stake-preview-value min-win" id="previewMinWin">$0</span>
                        </div>
                        <div class="stake-preview-item">
                            <span class="stake-preview-label">Max Winning:</span>
                            <span class="stake-preview-value max-win" id="previewMaxWin">$0</span>
                        </div>
                    </div>
                </div>

                <div class="word-buttons">
                    <button class="word-btn" data-words="3">
                        <span class="btn-label">W3</span>
                        <span class="btn-payout">$5-$200</span>
                    </button>
                    <button class="word-btn" data-words="4">
                        <span class="btn-label">W4</span>
                        <span class="btn-payout">$0.2-$200</span>
                    </button>
                    <button class="word-btn" data-words="5">
                        <span class="btn-label">W5</span>
                        <span class="btn-payout">$0.2-$200</span>
                    </button>
                    <button class="word-btn" data-words="6">
                        <span class="btn-label">W6</span>
                        <span class="btn-payout">$0.2-$200</span>
                    </button>
                    <button class="word-btn" data-words="7">
                        <span class="btn-label">W7</span>
                        <span class="btn-payout">$0.2-$200</span>
                    </button>
                    <button class="word-btn" data-words="8">
                        <span class="btn-label">W8</span>
                        <span class="btn-payout">$0.2-$200</span>
                    </button>
                    <button class="word-btn" data-words="9">
                        <span class="btn-label">W9</span>
                        <span class="btn-payout">$0.2-$200</span>
                    </button>
                    <button class="word-btn" data-words="10">
                        <span class="btn-label">W10</span>
                        <span class="btn-payout">$0.2-$200</span>
                    </button>
                </div>

                <button class="place-bet-btn" id="placeBetBtn" disabled>
                    <i class="fas fa-coins"></i> Place Bet
                </button>

                <div class="score-display">
                    <div class="score-item">
                        <div class="score-value" id="balanceValue">1000</div>
                        <div class="score-label">Balance ($)</div>
                    </div>
                    <div class="score-item">
                        <div class="score-value" id="winValue">0</div>
                        <div class="score-label">Winnings ($)</div>
                    </div>
                    <div class="score-item">
                        <div class="score-value" id="betValue">0</div>
                        <div class="score-label">Current Bet ($)</div>
                    </div>
                </div>

                <!-- Stake Display (After Bet Result) -->
                <div class="stake-display" id="stakeDisplay">
                    <div class="stake-header">
                        <i class="fas fa-coins"></i>
                        <h3>Bet Summary</h3>
                    </div>
                    <div class="stake-details">
                        <div class="stake-item">
                            <span class="stake-label">Stake:</span>
                            <span class="stake-value" id="stakeAmount">$0</span>
                        </div>
                        <div class="stake-item">
                            <span class="stake-label">Word Length:</span>
                            <span class="stake-value" id="stakeWordLength">W3</span>
                        </div>
                        <div class="stake-item">
                            <span class="stake-label">Payout Rate:</span>
                            <span class="stake-value" id="stakePayout">0x</span>
                        </div>
                        <div class="stake-item">
                            <span class="stake-label">Potential Win:</span>
                            <span class="stake-value positive" id="stakePotentialWin">$0</span>
                        </div>
                        <div class="stake-item">
                            <span class="stake-label">Actual Result:</span>
                            <span class="stake-value" id="stakeResult">$0</span>
                        </div>
                        <div class="stake-item">
                            <span class="stake-label">Net Change:</span>
                            <span class="stake-value" id="stakeNetChange">$0</span>
                        </div>
                    </div>
                </div>

                <button class="records-btn" id="recordsBtn">
                    <i class="fas fa-history"></i> View Game Records
                </button>
            </div>

            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-th-large"></i> Sentence Construction</h2>
                
                <div class="sentence-area" id="sentenceArea">
                    <!-- Words will appear here when selected -->
                    <p id="placeholderText">Select words from the word selector...</p>
                </div>

                <div class="ai-response" id="aiResponse">
                    <div class="ai-header">
                        <i class="fas fa-robot"></i>
                        <h3>AI Evaluation</h3>
                    </div>
                    <div id="aiText">Waiting for evaluation...</div>
                </div>
            </div>
        </div>

        <footer>
            <p>SYNTAXBET &copy; 2026 | Part of the EnglaBet Language Learning System</p>
        </footer>
    </div>

    <!-- NEW: Numbers Page (Overlay) -->
    <div class="numbers-page-overlay" id="numbersPage">
        <div class="numbers-header">
            <div class="numbers-header-title">
                <i class="fas fa-th-large"></i>
                <h2>Word Selector</h2>
            </div>
            <button class="close-numbers-btn" id="closeNumbersBtn">
                <i class="fas fa-times"></i> Close
            </button>
        </div>

        <div class="numbers-grid-container">
            <div class="numbers-grid-full" id="numbersGridFull">
                <!-- Numbers 1-100 will be generated by JavaScript -->
            </div>
        </div>

        <div class="numbers-footer">
            <!-- Selection info removed completely -->
        </div>
    </div>

    <!-- Help Overlay -->
    <div class="overlay" id="helpOverlay">
        <div class="overlay-content">
            <button class="overlay-close" id="helpClose">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="overlay-title"><i class="fas fa-question-circle"></i> Game Help</h2>
            
            <div class="help-examples">
                <h3 class="panel-title"><i class="fas fa-lightbulb"></i> Example Sentences</h3>
                <div class="help-examples-grid">
                    <div class="help-example">W3: [I] [AM] [HERE]</div>
                    <div class="help-example">W4: [BRING] [BACK] [MY] [PHONE]</div>
                    <div class="help-example">W5: [STAY] [WITH] [US] [FOR] [NOW]</div>
                    <div class="help-example">W6: [IT] [ONLY] [WORKS] [FOR] [YOUNG] [PEOPLE]</div>
                    <div class="help-example">W7: [YOU] [CANNOT] [GO] [TO] [THE] [GYM] [ALONE]</div>
                    <div class="help-example">W8: [WHY] [IS] [IT] [TAKING] [TOO] [LONG] [TO] [LAND]</div>
                </div>
            </div>
            
            <div class="help-rules">
                <h3 class="panel-title"><i class="fas fa-info-circle"></i> Game Rules</h3>
                <ul>
                    <li><strong>Stake Rules:</strong> W3: $5-$200  $1,000-$40,000 | W4-W10: $0.2-$200  $20-$55,000</li>
                    <li>Enter your stake amount in the stake entry box</li>
                    <li>Select word length (W3-W10) for your sentence</li>
                    <li>Click "Place Bet" to open word selector</li>
                    <li>Select the specified number of words from the number grid</li>
                    <li>Words appear in the sentence area when selected</li>
                    <li>Words must be arranged in the correct grammatical order</li>
                    <li>Your sentence will be automatically evaluated when all words are selected</li>
                    <li>Win your stake multiplied by the payout rate if your sentence is valid</li>
                    <li>Challenge yourself to create more complex sentences for higher payouts</li>
                    <li>Each round has a 2-minute time limit</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Records Modal -->
    <div class="records-modal" id="recordsModal">
        <div class="records-modal-content">
            <div class="records-modal-header">
                <h2 class="records-modal-title">
                    <i class="fas fa-trophy"></i> Game Records
                </h2>
                <button class="records-modal-close" id="recordsModalClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="records-stats">
                <div class="record-stat">
                    <div class="record-stat-value" id="totalGames">0</div>
                    <div class="record-stat-label">Total Games</div>
                </div>
                <div class="record-stat">
                    <div class="record-stat-value" id="gamesWon">0</div>
                    <div class="record-stat-label">Games Won</div>
                </div>
                <div class="record-stat">
                    <div class="record-stat-value" id="winRate">0%</div>
                    <div class="record-stat-label">Win Rate</div>
                </div>
            </div>

            <div class="records-table-container">
                <table class="records-table-modal" id="recordsTableModal">
                    <thead>
                        <tr>
                            <th>Word Length</th>
                            <th>You Arranged</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Stake ($)</th>
                            <th>Winning ($)</th>
                        </tr>
                    </thead>
                    <tbody id="recordsBodyModal">
                        <!-- Records will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <script>
        // ==============================
        // SUPABASE CONFIGURATION
        // ==============================
        const SUPABASE_URL = 'https://sgtskerheqsfgiusdgaf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNndHNrZXJoZXFzZmdpdXNkZ2FmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNDY4MDYsImV4cCI6MjA4MTYyMjgwNn0.rcvjGk8qpH6cV33gAr3LH44w5MNAjToq29-xiq2uTtM';
        
        // Create Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ==============================
        // STATE
        // ==============================
        let selectedNumbers = [];
        let sentenceWords = [];
        let balance = 1000;
        let currentBet = 0;
        let selectedWordCount = 3; // Default to W3
        let currentTopic = "";
        let wordDatabase = {};
        let roundActive = false;
        let timerInterval;
        let timeLeft = 120; // 2 minutes in seconds
        let gameRecords = [];
        let currentUser = null;
        let numbersPageOpen = false;
        let currentStake = 0;

        // Google AI Studio API key
        const GOOGLE_AI_API_KEY = "AIzaSyC5GqryX1qgFzT-iAJMdsajqiNPAAhm70o";

        // ==============================
        // DOM ELEMENTS
        // ==============================
        const authModal = document.getElementById('auth-modal');
        const authError = document.getElementById('auth-error');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const authLoading = document.getElementById('auth-loading');
        const loginEmail = document.getElementById('login-email');
        const loginPassword = document.getElementById('login-password');
        const loginSubmit = document.getElementById('login-submit');
        const showRegister = document.getElementById('show-register');
        const registerEmail = document.getElementById('register-email');
        const registerPassword = document.getElementById('register-password');
        const registerFullname = document.getElementById('register-fullname');
        const registerSubmit = document.getElementById('register-submit');
        const showLogin = document.getElementById('show-login');
        const gameContainer = document.getElementById('game-container');
        const userInfo = document.getElementById('user-info');
        const userName = document.getElementById('user-name');
        const userAvatar = document.getElementById('user-avatar');
        const logoutBtn = document.getElementById('logout-btn');
        const sentenceArea = document.getElementById('sentenceArea');
        const placeholderText = document.getElementById('placeholderText');
        const topicBox = document.getElementById('topicBox');
        const placeBetBtn = document.getElementById('placeBetBtn');
        const wordButtons = document.querySelectorAll('.word-btn');
        const aiResponse = document.getElementById('aiResponse');
        const aiText = document.getElementById('aiText');
        const balanceValue = document.getElementById('balanceValue');
        const winValue = document.getElementById('winValue');
        const betValue = document.getElementById('betValue');
        const timerElement = document.getElementById('timer');
        const timerValue = document.getElementById('timerValue');
        const helpBtn = document.getElementById('helpBtn');
        const helpOverlay = document.getElementById('helpOverlay');
        const helpClose = document.getElementById('helpClose');
        const correctionsBtn = document.getElementById('correctionsBtn');
        const recordsBtn = document.getElementById('recordsBtn');
        const recordsModal = document.getElementById('recordsModal');
        const recordsModalClose = document.getElementById('recordsModalClose');
        const recordsBodyModal = document.getElementById('recordsBodyModal');
        const totalGames = document.getElementById('totalGames');
        const gamesWon = document.getElementById('gamesWon');
        const winRate = document.getElementById('winRate');
        
        // Stake Entry Elements
        const stakeAmountInput = document.getElementById('stakeAmountInput');
        const stakeRangeInfo = document.getElementById('stakeRangeInfo');
        const stakePreview = document.getElementById('stakePreview');
        const previewWordLength = document.getElementById('previewWordLength');
        const previewStakeAmount = document.getElementById('previewStakeAmount');
        const previewMinWin = document.getElementById('previewMinWin');
        const previewMaxWin = document.getElementById('previewMaxWin');
        
        // Stake Display Elements
        const stakeDisplay = document.getElementById('stakeDisplay');
        const stakeAmount = document.getElementById('stakeAmount');
        const stakeWordLength = document.getElementById('stakeWordLength');
        const stakePayout = document.getElementById('stakePayout');
        const stakePotentialWin = document.getElementById('stakePotentialWin');
        const stakeResult = document.getElementById('stakeResult');
        const stakeNetChange = document.getElementById('stakeNetChange');
        
        // Numbers Page Elements
        const numbersPage = document.getElementById('numbersPage');
        const numbersGridFull = document.getElementById('numbersGridFull');
        const closeNumbersBtn = document.getElementById('closeNumbersBtn');

        // Stake configuration as per your requirements
        const stakeConfig = {
            3: { // W3 - SPECIAL CASE
                minStake: 5,
                maxStake: 200,
                minWin: 1000,
                maxWin: 40000,
                description: "W3: $5-$200  $1,000-$40,000"
            },
            4: { // W4
                minStake: 0.2,
                maxStake: 200,
                minWin: 20,
                maxWin: 45000,
                description: "W4: $0.2-$200  $20-$45,000"
            },
            5: { // W5
                minStake: 0.2,
                maxStake: 200,
                minWin: 22,
                maxWin: 46000,
                description: "W5: $0.2-$200  $22-$46,000"
            },
            6: { // W6
                minStake: 0.2,
                maxStake: 200,
                minWin: 25,
                maxWin: 47000,
                description: "W6: $0.2-$200  $25-$47,000"
            },
            7: { // W7
                minStake: 0.2,
                maxStake: 200,
                minWin: 27,
                maxWin: 48000,
                description: "W7: $0.2-$200  $27-$48,000"
            },
            8: { // W8
                minStake: 0.2,
                maxStake: 200,
                minWin: 30,
                maxWin: 50000,
                description: "W8: $0.2-$200  $30-$50,000"
            },
            9: { // W9
                minStake: 0.2,
                maxStake: 200,
                minWin: 32,
                maxWin: 52000,
                description: "W9: $0.2-$200  $32-$52,000"
            },
            10: { // W10
                minStake: 0.2,
                maxStake: 200,
                minWin: 35,
                maxWin: 55000,
                description: "W10: $0.2-$200  $35-$55,000"
            }
        };

        // ==============================
        // UTILITY FUNCTIONS
        // ==============================
        function showNotification(message, type = "info") {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function showAuthError(message) {
            authError.textContent = message;
            authError.style.display = 'block';
            setTimeout(() => {
                authError.style.display = 'none';
            }, 5000);
        }

        function showAuthModal() {
            authModal.style.display = 'flex';
            loginForm.style.display = 'block';
            registerForm.style.display = 'none';
            authLoading.style.display = 'none';
            loginEmail.value = '';
            loginPassword.value = '';
            registerEmail.value = '';
            registerPassword.value = '';
            registerFullname.value = '';
        }

        function hideAuthModal() {
            authModal.style.display = 'none';
        }

        function showGameInterface() {
            gameContainer.style.display = 'block';
            userInfo.style.display = 'flex';
            userName.textContent = currentUser.user_metadata?.full_name || currentUser.email.split('@')[0];
            userAvatar.src = currentUser.user_metadata?.profile_photo_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(userName.textContent)}&background=4cc9f0&color=fff`;
            logoutBtn.style.display = 'block';
        }

        // ==============================
        // AUTHENTICATION FUNCTIONS
        // ==============================
        async function handleLogin(email, password) {
            try {
                loginSubmit.disabled = true;
                loginSubmit.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing in...';
                authError.style.display = 'none';
                
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email.trim(),
                    password: password
                });
                
                if (error) {
                    showAuthError(error.message);
                    loginSubmit.disabled = false;
                    loginSubmit.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In';
                    return;
                }
                
                if (data.user) {
                    currentUser = data.user;
                    hideAuthModal();
                    showGameInterface();
                    await initializeGame();
                }
                
            } catch (error) {
                console.error('Login error:', error);
                showAuthError('An unexpected error occurred');
                loginSubmit.disabled = false;
                loginSubmit.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In';
            }
        }

        async function handleRegister(email, password, fullname) {
            try {
                registerSubmit.disabled = true;
                registerSubmit.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating account...';
                authError.style.display = 'none';
                
                // Validate inputs
                if (!email || !password || !fullname) {
                    showAuthError('All fields are required');
                    registerSubmit.disabled = false;
                    registerSubmit.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
                    return;
                }
                
                if (password.length < 6) {
                    showAuthError('Password must be at least 6 characters');
                    registerSubmit.disabled = false;
                    registerSubmit.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
                    return;
                }
                
                const { data, error } = await supabase.auth.signUp({
                    email: email.trim(),
                    password: password,
                    options: {
                        data: {
                            full_name: fullname.trim(),
                            created_at: new Date().toISOString()
                        }
                    }
                });
                
                if (error) {
                    showAuthError(error.message);
                    registerSubmit.disabled = false;
                    registerSubmit.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
                    return;
                }
                
                if (data.user) {
                    // Show success message and switch to login
                    showAuthError('Account created successfully! Please sign in.');
                    showLogin.click();
                }
                
            } catch (error) {
                console.error('Register error:', error);
                showAuthError('An unexpected error occurred');
                registerSubmit.disabled = false;
                registerSubmit.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
            }
        }

        async function handleLogout() {
            try {
                await supabase.auth.signOut();
                currentUser = null;
                showAuthModal();
                gameContainer.style.display = 'none';
                showNotification('Logged out successfully', 'success');
            } catch (error) {
                console.error('Logout error:', error);
                showNotification('Error logging out', 'error');
            }
        }

        async function checkAuthState() {
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    console.error("Error getting session:", error);
                    showAuthModal();
                    return;
                }
                
                if (!session) {
                    showAuthModal();
                    return;
                }
                
                currentUser = session.user;
                showGameInterface();
                await initializeGame();
                
            } catch (error) {
                console.error("Auth check error:", error);
                showAuthModal();
            }
        }

        // ==============================
        // DIRECT SUPABASE FUNCTIONS
        // ==============================
        async function fetchUserDataDirect() {
            if (!currentUser) return null;
            
            try {
                // Fetch user data directly from Supabase table
                const { data, error } = await supabase
                    .from('englabet_users')
                    .select('syntaxbet_balance, syntaxbet_records, updated_at')
                    .eq('auth_user_id', currentUser.id)
                    .single();
                
                if (error) {
                    console.error("Error fetching user data:", error);
                    return null;
                }
                
                return data;
                
            } catch (error) {
                console.error("Error in direct user fetch:", error);
                return null;
            }
        }

        async function fetchBalanceDirect() {
            if (!currentUser) return balance;
            
            try {
                const { data, error } = await supabase
                    .from('englabet_users')
                    .select('syntaxbet_balance')
                    .eq('auth_user_id', currentUser.id)
                    .single();
                
                if (error) {
                    console.error("Error fetching balance:", error);
                    return balance;
                }
                
                return data.syntaxbet_balance || balance;
                
            } catch (error) {
                console.error("Error in direct balance fetch:", error);
                return balance;
            }
        }

        async function fetchRecordsDirect() {
            if (!currentUser) return [];
            
            try {
                const { data, error } = await supabase
                    .from('englabet_users')
                    .select('syntaxbet_records')
                    .eq('auth_user_id', currentUser.id)
                    .single();
                
                if (error) {
                    console.error("Error fetching records:", error);
                    return [];
                }
                
                return data.syntaxbet_records || [];
                
            } catch (error) {
                console.error("Error in direct records fetch:", error);
                return [];
            }
        }

        async function updateUserBalanceInSupabase(newBalance) {
            if (!currentUser) return;
            
            try {
                // Check if user exists in englabet_users table
                const { data: existingUser, error: fetchError } = await supabase
                    .from('englabet_users')
                    .select('auth_user_id')
                    .eq('auth_user_id', currentUser.id)
                    .single();
                
                if (fetchError && fetchError.code !== 'PGRST116') {
                    console.error("Error checking user:", fetchError);
                    return;
                }
                
                if (existingUser) {
                    // Update existing user
                    const { error } = await supabase
                        .from('englabet_users')
                        .update({
                            syntaxbet_balance: newBalance,
                            updated_at: new Date().toISOString()
                        })
                        .eq('auth_user_id', currentUser.id);
                    
                    if (error) {
                        console.error("Error updating balance:", error);
                    }
                } else {
                    // Create new user record
                    const { error } = await supabase
                        .from('englabet_users')
                        .insert({
                            auth_user_id: currentUser.id,
                            email: currentUser.email,
                            full_name: currentUser.user_metadata?.full_name || currentUser.email.split('@')[0],
                            syntaxbet_balance: newBalance,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        });
                    
                    if (error) {
                        console.error("Error creating user record:", error);
                    }
                }
            } catch (error) {
                console.error("Error updating user balance in Supabase:", error);
            }
        }

        async function saveRecordToSupabase(record) {
            if (!currentUser) return;
            
            try {
                // First, get existing records
                const existingData = await fetchRecordsDirect();
                const existingRecords = Array.isArray(existingData) ? existingData : [];
                
                // Add new record at the beginning
                const updatedRecords = [record, ...existingRecords].slice(0, 20); // Keep only last 20 records
                
                // Update records in Supabase
                const { error } = await supabase
                    .from('englabet_users')
                    .update({
                        syntaxbet_records: updatedRecords,
                        updated_at: new Date().toISOString()
                    })
                    .eq('auth_user_id', currentUser.id);
                
                if (error) {
                    console.error("Error saving record:", error);
                }
            } catch (error) {
                console.error("Error saving record to Supabase:", error);
            }
        }

        // ==============================
        // GAME FUNCTIONS
        // ==============================
        async function initializeGame() {
            if (!currentUser) {
                showAuthModal();
                return;
            }
            
            try {
                // Load user data from Supabase
                await loadUserData();
                
                // Generate random topic using Google AI API
                generateRandomTopic();
                
                // Create number grid for numbers page
                createNumbersGrid();
                
                // Event listeners
                setupEventListeners();
                
                // Set default word count to W3
                selectWordCount(3);
                
                // Start the timer always
                startTimer();
                
                // Update UI
                updateUI();
                
                // Load game records from Supabase
                await loadGameRecords();
                
            } catch (error) {
                console.error("Error initializing game:", error);
                showNotification("Error initializing game: " + error.message, "error");
            }
        }

        async function loadUserData() {
            try {
                // Load balance from Supabase
                const userBalance = await fetchBalanceDirect();
                if (userBalance !== null) {
                    balance = userBalance;
                }
                
                // Load records from Supabase
                await loadGameRecords();
                
            } catch (error) {
                console.error("Error loading user data:", error);
            }
        }

        async function loadGameRecords() {
            try {
                const records = await fetchRecordsDirect();
                gameRecords = records;
                updateRecordsModal();
            } catch (error) {
                console.error("Error loading game records:", error);
            }
        }

        function setupEventListeners() {
            // Auth form switching
            showRegister.addEventListener('click', () => {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                authError.style.display = 'none';
            });
            
            showLogin.addEventListener('click', () => {
                registerForm.style.display = 'none';
                loginForm.style.display = 'block';
                authError.style.display = 'none';
            });
            
            // Login form
            loginSubmit.addEventListener('click', async () => {
                const email = loginEmail.value;
                const password = loginPassword.value;
                
                if (!email || !password) {
                    showAuthError('Please enter both email and password');
                    return;
                }
                
                await handleLogin(email, password);
            });
            
            // Register form
            registerSubmit.addEventListener('click', async () => {
                const email = registerEmail.value;
                const password = registerPassword.value;
                const fullname = registerFullname.value;
                
                await handleRegister(email, password, fullname);
            });
            
            // Logout
            logoutBtn.addEventListener('click', handleLogout);
            
            // Game event listeners
            placeBetBtn.addEventListener('click', placeBet);
            helpBtn.addEventListener('click', showHelp);
            helpClose.addEventListener('click', hideHelp);
            correctionsBtn.addEventListener('click', showCorrections);
            recordsBtn.addEventListener('click', showRecordsModal);
            recordsModalClose.addEventListener('click', hideRecordsModal);
            closeNumbersBtn.addEventListener('click', closeNumbersPage);
            
            // Stake entry event listeners
            stakeAmountInput.addEventListener('input', validateStakeAmount);
            
            // Close modal when clicking outside
            recordsModal.addEventListener('click', (e) => {
                if (e.target === recordsModal) {
                    hideRecordsModal();
                }
            });
            
            // Word button event listeners
            wordButtons.forEach(button => {
                button.addEventListener('click', () => {
                    selectWordCount(parseInt(button.dataset.words));
                });
            });

            // Keyboard shortcuts for login
            loginEmail.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') loginSubmit.click();
            });
            
            loginPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') loginSubmit.click();
            });
            
            registerEmail.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') registerSubmit.click();
            });
            
            registerPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') registerSubmit.click();
            });
            
            registerFullname.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') registerSubmit.click();
            });
        }

        // Create numbers grid for the numbers page
        function createNumbersGrid() {
            numbersGridFull.innerHTML = '';
            for (let i = 1; i <= 100; i++) {
                const numberElement = document.createElement('div');
                numberElement.className = 'number-full';
                numberElement.dataset.number = i;
                
                const numberLabel = document.createElement('div');
                numberLabel.textContent = i;
                numberLabel.className = 'number-label';
                
                const numberWord = document.createElement('div');
                numberWord.className = 'number-word';
                numberWord.textContent = '???';
                numberWord.style.display = 'none'; // HIDE THE WORDS
                
                numberElement.appendChild(numberLabel);
                numberElement.appendChild(numberWord);
                
                numberElement.addEventListener('click', () => {
                    if (numbersPageOpen && roundActive) {
                        toggleNumberSelection(i, numberElement);
                    }
                });
                
                numbersGridFull.appendChild(numberElement);
            }
        }

        // Update number grid with actual words when needed
        function updateNumbersGrid() {
            for (let i = 1; i <= 100; i++) {
                const numberElement = numbersGridFull.querySelector(`.number-full[data-number="${i}"]`);
                if (numberElement && wordDatabase[i]) {
                    const wordElement = numberElement.querySelector('.number-word');
                    wordElement.textContent = wordDatabase[i];
                    wordElement.style.display = 'none'; // Ensure words are hidden
                }
            }
        }

        // Generate random topic using Google AI Studio API
        async function generateRandomTopic() {
            topicBox.innerHTML = '<div class="loading"></div> Generating topic...';
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GOOGLE_AI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: "Generate a short dialogue between two people on a random everyday topic. The dialogue should be between 4-8 lines total, with each line being a complete sentence. Format it like this example:\n\nDialogue Bank [Topic] \n\nPERSON1: [FIRST SENTENCE] [SECOND SENTENCE]\nPERSON2: [THIRD SENTENCE] [FOURTH SENTENCE]\n\nPlease create a completely different dialogue on a new topic. Do not use restaurant or food-related topics."
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.8,
                            maxOutputTokens: 300,
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to generate topic');
                }

                const data = await response.json();
                const generatedTopic = data.candidates[0].content.parts[0].text;
                
                currentTopic = generatedTopic;
                topicBox.textContent = generatedTopic;
                
                // Generate word database based on topic
                generateWordDatabase(generatedTopic);
                // Update numbers grid with words
                updateNumbersGrid();
            } catch (error) {
                console.error('Error generating topic:', error);
                // Fallback to a default topic if API fails
                const fallbackTopic = `Dialogue Bank [Travel Plans] 

PERSON1: [WHERE ARE YOU PLANNING TO GO] [WHEN WILL YOU LEAVE]
PERSON2: [I WANT TO VISIT JAPAN] [I WILL TRAVEL NEXT MONTH]
PERSON1: [HOW LONG WILL YOU STAY] [HAVE YOU BOOKED YOUR FLIGHT]
PERSON2: [I WILL STAY FOR TWO WEEKS] [I NEED TO FIND A HOTEL FIRST]`;
                
                currentTopic = fallbackTopic;
                topicBox.textContent = fallbackTopic;
                generateWordDatabase(fallbackTopic);
                updateNumbersGrid();
            }
        }

        // Generate word database from topic
        function generateWordDatabase(topic) {
            wordDatabase = {};
            
            // Extract words from the topic
            const words = topic
                .replace(/[\[\]]/g, ' ') // Remove brackets
                .replace(/[^\w\s]/g, '') // Remove punctuation
                .toUpperCase()
                .split(/\s+/)
                .filter(word => word.length > 1) // Remove single letters
                .filter((word, index, self) => self.indexOf(word) === index); // Remove duplicates
            
            // Fill the rest with random words if needed
            const dictionaryWords = [
                "ABOUT", "AFTER", "AGAIN", "AIR", "ALL", "ALONG", "ALSO", "AN", "AND", "ANOTHER", "ANY", "ARE", "AROUND", "AS", "AT", "AWAY", "BACK", "BE", "BECAUSE", "BEEN", "BEFORE", "BEGAN", "BEST", "BETTER", "BIG", "BLACK", "BLUE", "BOOK", "BOTH", "BOX", "BRING", "BUT", "BY", "CALL", "CAME", "CAN", "CAR", "CARE", "CARRIED", "CARRY", "CHANGE", "CITY", "CLOSE", "COME", "COULD", "CUT", "DARK", "DAY", "DID", "DIFFERENT", "DO", "DOES", "DONT", "DOWN", "EACH", "END", "EVEN", "EVERY", "EYE", "FACE", "FALL", "FAR", "FARM", "FAST", "FATHER", "FEET", "FEW", "FIND", "FIRST", "FIVE", "FLY", "FOOD", "FOR", "FORM", "FOUND", "FOUR", "FROM", "FULL", "GAVE", "GET", "GIVE", "GO", "GOING", "GOOD", "GOT", "GREAT", "GREEN", "GROW", "HAD", "HAND", "HARD", "HAS", "HAVE", "HE", "HEAD", "HEAR", "HELP", "HER", "HERE", "HIGH", "HIM", "HIS", "HOME", "HOUSE", "HOW", "I", "IF", "IN", "INTO", "IS", "IT", "ITS", "JUST", "KEEP", "KIND", "KNOW", "LAND", "LARGE", "LAST", "LATE", "LAUGH", "LEARN", "LEFT", "LET", "LETTER", "LIFE", "LIGHT", "LIKE", "LINE", "LISTEN", "LITTLE", "LIVE", "LONG", "LOOK", "MADE", "MAKE", "MAN", "MANY", "MAY", "ME", "MEN", "MIGHT", "MILE", "MISS", "MORE", "MOST", "MOTHER", "MOUNTAIN", "MOVE", "MUCH", "MUST", "MY", "MYSELF", "NAME", "NEAR", "NEED", "NEVER", "NEW", "NEXT", "NIGHT", "NO", "NOT", "NOW", "NUMBER", "OF", "OFF", "OLD", "ON", "ONCE", "ONE", "ONLY", "OPEN", "OR", "OTHER", "OUR", "OUT", "OVER", "OWN", "PAGE", "PART", "PEOPLE", "PICTURE", "PLACE", "PLAY", "POINT", "PUT", "READ", "RED", "RIGHT", "ROOM", "RUN", "SAID", "SAME", "SAW", "SAY", "SCHOOL", "SEE", "SEEM", "SENTENCE", "SET", "SHE", "SHOULD", "SHOW", "SIDE", "SMALL", "SO", "SOME", "SOMETHING", "SOON", "SOUND", "SPELL", "START", "STATE", "STILL", "STOP", "STORY", "STUDY", "SUCH", "TAKE", "TALK", "TELL", "THAN", "THAT", "THE", "THEIR", "THEM", "THEN", "THERE", "THESE", "THEY", "THING", "THINK", "THIS", "THOSE", "THOUGHT", "THREE", "THROUGH", "TIME", "TO", "TOGETHER", "TOO", "TOOK", "TREE", "TURN", "TWO", "UNDER", "UP", "US", "USE", "VERY", "WALK", "WANT", "WAS", "WATCH", "WATER", "WAY", "WE", "WELL", "WENT", "WERE", "WHAT", "WHEN", "WHERE", "WHICH", "WHILE", "WHITE", "WHO", "WHY", "WILL", "WITH", "WORD", "WORK", "WORLD", "WOULD", "WRITE", "YEAR", "YES", "YOU", "YOUR"
            ];
            
            // Shuffle dictionary words
            const shuffledDictionary = [...dictionaryWords].sort(() => 0.5 - Math.random());
            
            // Create an array of all numbers from 1 to 100
            const allNumbers = Array.from({length: 100}, (_, i) => i + 1);
            
            // Shuffle the numbers randomly
            const shuffledNumbers = [...allNumbers].sort(() => 0.5 - Math.random());
            
            // Assign words to shuffled numbers
            for (let i = 0; i < 100; i++) {
                if (i < words.length) {
                    wordDatabase[shuffledNumbers[i]] = words[i];
                } else {
                    wordDatabase[shuffledNumbers[i]] = shuffledDictionary[i - words.length] || "WORD";
                }
            }
        }

        // Validate stake amount based on selected word count
        function validateStakeAmount() {
            const config = stakeConfig[selectedWordCount];
            let stake = parseFloat(stakeAmountInput.value) || 0;
            
            // Clear previous validation state
            stakeAmountInput.classList.remove('invalid', 'valid');
            
            // Check if stake is within range
            if (stake < config.minStake) {
                stakeAmountInput.classList.add('invalid');
                stakeAmountInput.setAttribute('title', `Minimum stake for W${selectedWordCount} is $${config.minStake}`);
                showPreview(false);
            } else if (stake > config.maxStake) {
                stakeAmountInput.classList.add('invalid');
                stakeAmountInput.setAttribute('title', `Maximum stake for W${selectedWordCount} is $${config.maxStake}`);
                showPreview(false);
            } else if (stake > 0) {
                stakeAmountInput.classList.add('valid');
                stakeAmountInput.removeAttribute('title');
                showPreview(true);
                updateStakePreview(stake);
            } else {
                showPreview(false);
            }
            
            // Update place bet button state
            placeBetBtn.disabled = !(stake >= config.minStake && stake <= config.maxStake && stake <= balance);
            
            // Auto-set current stake
            if (stake >= config.minStake && stake <= config.maxStake && stake <= balance) {
                currentStake = stake;
            } else {
                currentStake = 0;
            }
        }

        // Show/hide stake preview
        function showPreview(show) {
            if (show) {
                stakePreview.style.display = 'grid';
            } else {
                stakePreview.style.display = 'none';
            }
        }

        // Update stake preview
        function updateStakePreview(stake) {
            const config = stakeConfig[selectedWordCount];
            const winnings = calculateWinnings(stake, selectedWordCount);
            
            previewWordLength.textContent = `W${selectedWordCount}`;
            previewStakeAmount.textContent = `$${stake.toFixed(2)}`;
            previewMinWin.textContent = `$${config.minWin.toLocaleString()}`;
            previewMaxWin.textContent = `$${config.maxWin.toLocaleString()}`;
            
            // Calculate and show potential winnings for this stake
            const potentialWin = calculateWinnings(stake, selectedWordCount);
            stakeAmountInput.setAttribute('data-potential-win', potentialWin);
        }

        // Calculate winnings based on stake and word count
        function calculateWinnings(stake, wordCount) {
            const config = stakeConfig[wordCount];
            
            // Calculate winnings proportionally
            // Linear interpolation between min and max winnings based on stake
            const stakeRange = config.maxStake - config.minStake;
            const winRange = config.maxWin - config.minWin;
            
            if (stakeRange === 0) {
                return config.maxWin; // If min and max stake are the same
            }
            
            const proportion = (stake - config.minStake) / stakeRange;
            const winnings = config.minWin + (proportion * winRange);
            
            return Math.round(winnings);
        }

        // Select word count
        function selectWordCount(count) {
            selectedWordCount = count;
            const config = stakeConfig[count];
            
            // Update UI
            wordButtons.forEach(button => {
                if (parseInt(button.dataset.words) === count) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
            
            // Update stake range info
            stakeRangeInfo.textContent = config.description;
            
            // Update stake input min/max
            stakeAmountInput.min = config.minStake;
            stakeAmountInput.max = config.maxStake;
            stakeAmountInput.placeholder = `Enter $${config.minStake}-$${config.maxStake}`;
            
            // Re-validate stake amount for new word count
            validateStakeAmount();
        }

        // Place bet
        function placeBet() {
            if (currentStake <= 0) {
                showNotification('Please set a stake amount first', 'error');
                return;
            }
            
            const config = stakeConfig[selectedWordCount];
            
            if (currentStake < config.minStake) {
                showNotification(`Minimum stake for W${selectedWordCount} is $${config.minStake}`, 'error');
                return;
            }
            
            if (currentStake > config.maxStake) {
                showNotification(`Maximum stake for W${selectedWordCount} is $${config.maxStake}`, 'error');
                return;
            }
            
            if (currentStake > balance) {
                showNotification('Insufficient balance', 'error');
                return;
            }
            
            if (selectedWordCount < 3 || selectedWordCount > 10) {
                showNotification('Please select a word count between 3 and 10', 'error');
                return;
            }
            
            // Reset timer to 120 seconds when placing a bet
            resetTimer();
            
            // Deduct bet from balance
            balance -= currentStake;
            currentBet = currentStake;
            
            // Update balance in Supabase
            updateUserBalanceInSupabase(balance);
            
            // Start the round
            roundActive = true;
            
            // Reset selection for new round
            selectedNumbers = [];
            sentenceWords = [];
            updateSentenceArea();
            
            // Hide stake display
            stakeDisplay.classList.remove('show');
            
            // Update UI
            updateUI();
            
            // Disable stake entry during game
            stakeAmountInput.disabled = true;
            placeBetBtn.disabled = true;
            wordButtons.forEach(button => {
                button.disabled = true;
            });
            
            // Reset numbers grid
            resetNumbersGrid();
            
            // Open numbers page
            openNumbersPage();
            
            showNotification(`Bet placed: $${currentStake} on W${selectedWordCount}. Select ${selectedWordCount} words.`, 'success');
        }

        // Open numbers page
        function openNumbersPage() {
            numbersPageOpen = true;
            numbersPage.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent scrolling on main page
        }

        // Close numbers page
        function closeNumbersPage() {
            numbersPageOpen = false;
            numbersPage.classList.remove('active');
            document.body.style.overflow = ''; // Restore scrolling
            
            if (roundActive) {
                showNotification('Returned to main screen. Your selection is saved.', 'info');
            }
        }

        // Reset numbers grid selection
        function resetNumbersGrid() {
            const numberElements = numbersGridFull.querySelectorAll('.number-full');
            numberElements.forEach(element => {
                element.classList.remove('selected', 'disabled');
            });
        }

        // Toggle number selection
        async function toggleNumberSelection(number, element) {
            if (!roundActive || !numbersPageOpen) {
                return;
            }
            
            const index = selectedNumbers.indexOf(number);
            
            if (index === -1) {
                // Check if we've reached the maximum
                if (selectedNumbers.length >= selectedWordCount) {
                    showNotification(`You can only select ${selectedWordCount} words`, 'error');
                    return;
                }
                
                // Add to selection
                selectedNumbers.push(number);
                element.classList.add('selected');
                
                // Build sentence words from selected numbers
                sentenceWords = selectedNumbers.map(num => {
                    return {
                        number: num,
                        word: wordDatabase[num] || `Word ${num}`
                    };
                });
                
                // Update sentence area
                updateSentenceArea();
                
                // Check if selection is complete
                if (selectedNumbers.length === selectedWordCount) {
                    // Disable all other numbers
                    const allNumbers = numbersGridFull.querySelectorAll('.number-full');
                    allNumbers.forEach(numElement => {
                        if (!numElement.classList.contains('selected')) {
                            numElement.classList.add('disabled');
                        }
                    });
                    
                    // Wait a moment then automatically validate
                    setTimeout(async () => {
                        await validateSentence();
                    }, 500);
                }
            } else {
                // CANNOT remove selection - once selected, it's permanent
                showNotification('Word selection cannot be changed once selected', 'info');
            }
        }

        // Update sentence area
        function updateSentenceArea() {
            sentenceArea.innerHTML = '';
            
            if (sentenceWords.length === 0) {
                placeholderText.style.display = 'block';
                placeholderText.textContent = 'Select words from the word selector...';
                return;
            }
            
            placeholderText.style.display = 'none';
            
            sentenceWords.forEach((item, index) => {
                const wordElement = document.createElement('div');
                wordElement.className = 'sentence-word';
                wordElement.textContent = item.word;
                wordElement.dataset.number = item.number;
                wordElement.dataset.index = index;
                sentenceArea.appendChild(wordElement);
            });
        }

        // Reset timer to 120 seconds
        function resetTimer() {
            timeLeft = 120;
            updateTimerDisplay();
            
            // Clear any existing timer
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            // Start new timer
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    if (roundActive) {
                        endRound(false, "Time's up!");
                    } else {
                        // Reset timer for new round
                        timeLeft = 120;
                        updateTimerDisplay();
                    }
                }
            }, 1000);
        }

        // Start the countdown timer (always running)
        function startTimer() {
            timeLeft = 120; // Reset to 2 minutes
            updateTimerDisplay();
            
            // Clear any existing timer
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            // Start new timer
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    if (roundActive) {
                        endRound(false, "Time's up!");
                    } else {
                        // Reset timer for new round
                        timeLeft = 120;
                        updateTimerDisplay();
                    }
                }
            }, 1000);
        }

        // Update timer display
        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerValue.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Update timer styling based on time remaining
            timerElement.className = 'timer';
            if (timeLeft <= 30) {
                timerElement.classList.add('danger');
            } else if (timeLeft <= 60) {
                timerElement.classList.add('warning');
            } else {
                timerElement.classList.add('running');
            }
        }

        // End the current round
        async function endRound(isWin, message) {
            roundActive = false;
            numbersPageOpen = false;
            
            // Clear timer
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            // Close numbers page if open
            numbersPage.classList.remove('active');
            document.body.style.overflow = '';
            
            // Re-enable stake entry for next round
            stakeAmountInput.disabled = false;
            wordButtons.forEach(button => {
                button.disabled = false;
            });
            
            // Show notification
            showNotification(message, isWin ? 'success' : 'error');
            
            // Reset timer display
            timerElement.className = 'timer';
            timerValue.textContent = '02:00';
            
            // Automatically start next round after a delay
            setTimeout(startNewRound, 3000);
        }

        // Start new round
        function startNewRound() {
            // Reset game state
            selectedNumbers = [];
            sentenceWords = [];
            currentBet = 0;
            // Note: selectedWordCount is NOT reset - it persists between rounds
            roundActive = false;
            numbersPageOpen = false;
            
            // Clear UI
            sentenceArea.innerHTML = '';
            placeholderText.style.display = 'block';
            placeholderText.textContent = 'Select words from the word selector...';
            aiResponse.classList.remove('show');
            stakeDisplay.classList.remove('show');
            
            // Reset numbers grid
            resetNumbersGrid();
            
            // Update UI
            updateUI();
            
            // Generate new topic
            generateRandomTopic();
            
            // Start the timer again
            startTimer();
            
            showNotification('New round started! Enter your stake and place a bet.', 'info');
        }

        // Validate sentence
        async function validateSentence() {
            if (!roundActive) {
                showNotification('Please place a bet first', 'error');
                return;
            }
            
            if (sentenceWords.length !== selectedWordCount) {
                showNotification(`Sentence must contain exactly ${selectedWordCount} words`, 'error');
                return;
            }
            
            const sentence = sentenceWords.map(item => item.word).join(' ');
            
            try {
                // Use AI to validate the sentence
                const isValid = await validateSentenceWithAI(sentence, currentTopic);
                
                if (isValid) {
                    // Calculate winnings based on stake
                    const winnings = calculateWinnings(currentBet, selectedWordCount);
                    balance += winnings;
                    
                    // Update balance in Supabase
                    updateUserBalanceInSupabase(balance);
                    
                    // Update stake display
                    updateStakeDisplay(currentBet, selectedWordCount, winnings, true);
                    
                    // Update UI
                    winValue.textContent = winnings;
                    updateUI();
                    
                    // Create game record
                    const record = {
                        wordLength: `W${selectedWordCount}`,
                        arranged: sentence,
                        date: new Date().toLocaleString(),
                        status: "Won",
                        stake: currentBet,
                        winning: winnings,
                        netChange: winnings - currentBet,
                        topic: currentTopic.substring(0, 100) + (currentTopic.length > 100 ? "..." : "")
                    };
                    
                    // Add to local records
                    gameRecords.unshift(record);
                    if (gameRecords.length > 10) {
                        gameRecords = gameRecords.slice(0, 10);
                    }
                    
                    // Save to Supabase
                    await saveRecordToSupabase(record);
                    
                    // Show AI evaluation
                    showAIEvaluation(sentence, true, winnings);
                    
                    // End the round with win
                    endRound(true, `Congratulations! You won $${winnings}!`);
                } else {
                    // Update stake display for loss
                    updateStakeDisplay(currentBet, selectedWordCount, 0, false);
                    
                    // Create game record
                    const record = {
                        wordLength: `W${selectedWordCount}`,
                        arranged: sentence,
                        date: new Date().toLocaleString(),
                        status: "Lost",
                        stake: currentBet,
                        winning: 0,
                        netChange: -currentBet,
                        topic: currentTopic.substring(0, 100) + (currentTopic.length > 100 ? "..." : "")
                    };
                    
                    // Add to local records
                    gameRecords.unshift(record);
                    if (gameRecords.length > 10) {
                        gameRecords = gameRecords.slice(0, 10);
                    }
                    
                    // Save to Supabase
                    await saveRecordToSupabase(record);
                    
                    showAIEvaluation(sentence, false, 0);
                    // End the round with loss
                    endRound(false, 'Sentence does not match the topic. Try again next round!');
                }
            } catch (error) {
                console.error('Error validating sentence:', error);
                // Fallback to random validation if AI fails
                const isValid = Math.random() > 0.3; // 70% chance of being valid for demo
                
                if (isValid) {
                    const winnings = calculateWinnings(currentBet, selectedWordCount);
                    balance += winnings;
                    
                    // Update balance in Supabase
                    updateUserBalanceInSupabase(balance);
                    
                    // Update stake display
                    updateStakeDisplay(currentBet, selectedWordCount, winnings, true);
                    
                    winValue.textContent = winnings;
                    updateUI();
                    
                    // Create game record
                    const record = {
                        wordLength: `W${selectedWordCount}`,
                        arranged: sentence,
                        date: new Date().toLocaleString(),
                        status: "Won",
                        stake: currentBet,
                        winning: winnings,
                        netChange: winnings - currentBet,
                        topic: currentTopic.substring(0, 100) + (currentTopic.length > 100 ? "..." : "")
                    };
                    
                    // Add to local records
                    gameRecords.unshift(record);
                    if (gameRecords.length > 10) {
                        gameRecords = gameRecords.slice(0, 10);
                    }
                    
                    // Save to Supabase
                    await saveRecordToSupabase(record);
                    
                    showAIEvaluation(sentence, true, winnings);
                    // End the round with win
                    endRound(true, `Congratulations! You won $${winnings}!`);
                } else {
                    // Update stake display for loss
                    updateStakeDisplay(currentBet, selectedWordCount, 0, false);
                    
                    // Create game record
                    const record = {
                        wordLength: `W${selectedWordCount}`,
                        arranged: sentence,
                        date: new Date().toLocaleString(),
                        status: "Lost",
                        stake: currentBet,
                        winning: 0,
                        netChange: -currentBet,
                        topic: currentTopic.substring(0, 100) + (currentTopic.length > 100 ? "..." : "")
                    };
                    
                    // Add to local records
                    gameRecords.unshift(record);
                    if (gameRecords.length > 10) {
                        gameRecords = gameRecords.slice(0, 10);
                    }
                    
                    // Save to Supabase
                    await saveRecordToSupabase(record);
                    
                    showAIEvaluation(sentence, false, 0);
                    // End the round with loss
                    endRound(false, 'Sentence does not match the topic. Try again next round!');
                }
            }
        }

        // Update stake display
        function updateStakeDisplay(stake, wordLength, result, isWin) {
            const config = stakeConfig[wordLength];
            const potentialWin = calculateWinnings(stake, wordLength);
            const netChange = isWin ? result - stake : -stake;
            
            // Update stake display elements
            stakeAmount.textContent = `$${stake.toFixed(2)}`;
            stakeWordLength.textContent = `W${wordLength}`;
            
            // Calculate actual payout multiplier
            const payoutMultiplier = isWin ? Math.round(result / stake) : 0;
            stakePayout.textContent = `${payoutMultiplier}x`;
            
            stakePotentialWin.textContent = `$${potentialWin.toLocaleString()}`;
            stakeResult.textContent = `$${result.toLocaleString()}`;
            stakeNetChange.textContent = `$${netChange.toLocaleString()}`;
            
            // Color code net change
            stakeNetChange.className = 'stake-value';
            if (netChange > 0) {
                stakeNetChange.classList.add('positive');
            } else if (netChange < 0) {
                stakeNetChange.classList.add('negative');
            }
            
            // Color code result
            stakeResult.className = 'stake-value';
            if (result > 0) {
                stakeResult.classList.add('positive');
            }
            
            // Show stake display
            stakeDisplay.classList.add('show');
        }

        // Validate sentence with AI
        async function validateSentenceWithAI(sentence, topic) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GOOGLE_AI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `Evaluate if the following sentence is grammatically correct and makes sense in the context of the dialogue topic. Return only "valid" or "invalid".\n\nTopic: ${topic}\nSentence: ${sentence}`
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.1,
                            maxOutputTokens: 10,
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to validate sentence');
                }

                const data = await response.json();
                const result = data.candidates[0].content.parts[0].text.trim().toLowerCase();
                
                // Return true if the prediction is "valid"
                return result === "valid";
            } catch (error) {
                console.error('Error with AI validation:', error);
                throw error;
            }
        }

        // Show AI evaluation
        function showAIEvaluation(sentence, isValid, winnings) {
            let evaluation = "";
            
            if (isValid) {
                evaluation = `
                    <p>Your sentence "<strong>${sentence}</strong>" is valid and matches the topic!</p>
                    <p>You won <strong>$${winnings.toLocaleString()}</strong>!</p>
                    <p>The sentence follows proper grammatical structure and makes sense in the context of the dialogue.</p>
                `;
            } else {
                evaluation = `
                    <p>Your sentence "<strong>${sentence}</strong>" does not properly match the topic.</p>
                    <p>Try to create a sentence that fits within the context of the dialogue provided.</p>
                    <p>Consider the relationships between the characters and the situation described.</p>
                `;
            }
            
            aiText.innerHTML = evaluation;
            aiResponse.classList.add('show');
        }

        // Update records modal
        function updateRecordsModal() {
            recordsBodyModal.innerHTML = '';
            
            // Update stats
            const total = gameRecords.length;
            const won = gameRecords.filter(record => record.status === "Won").length;
            const rate = total > 0 ? Math.round((won / total) * 100) : 0;
            
            totalGames.textContent = total;
            gamesWon.textContent = won;
            winRate.textContent = `${rate}%`;
            
            // Populate table
            gameRecords.forEach(record => {
                const row = document.createElement('tr');
                
                const wordLengthCell = document.createElement('td');
                wordLengthCell.textContent = record.wordLength;
                
                const arrangedCell = document.createElement('td');
                arrangedCell.textContent = record.arranged;
                
                const dateCell = document.createElement('td');
                dateCell.textContent = record.date;
                
                const statusCell = document.createElement('td');
                statusCell.innerHTML = `<span class="status ${record.status.toLowerCase()}">${record.status}</span>`;
                
                const stakeCell = document.createElement('td');
                stakeCell.textContent = `$${record.stake.toFixed(2)}`;
                
                const winningCell = document.createElement('td');
                winningCell.textContent = record.winning > 0 ? `+$${record.winning.toLocaleString()}` : `$${record.winning}`;
                winningCell.className = record.winning > 0 ? 'win-amount' : 'loss-amount';
                
                row.appendChild(wordLengthCell);
                row.appendChild(arrangedCell);
                row.appendChild(dateCell);
                row.appendChild(statusCell);
                row.appendChild(stakeCell);
                row.appendChild(winningCell);
                
                recordsBodyModal.appendChild(row);
            });
        }

        // Show help overlay
        function showHelp() {
            helpOverlay.classList.add('active');
        }

        // Hide help overlay
        function hideHelp() {
            helpOverlay.classList.remove('active');
        }

        // Show corrections
        function showCorrections() {
            if (!roundActive) {
                showNotification('No active game to correct', 'error');
                return;
            }
            
            if (sentenceWords.length === 0) {
                showNotification('No sentence to correct yet', 'error');
                return;
            }
            
            // In a real implementation, this would show suggestions for improving the sentence
            // For now, we'll just show a notification
            showNotification('Corrections feature would suggest improvements to your sentence structure', 'info');
        }

        // Show records modal
        function showRecordsModal() {
            updateRecordsModal();
            recordsModal.classList.add('active');
        }

        // Hide records modal
        function hideRecordsModal() {
            recordsModal.classList.remove('active');
        }

        // Update UI
        function updateUI() {
            balanceValue.textContent = `$${balance.toFixed(2)}`;
            betValue.textContent = `$${currentBet.toFixed(2)}`;
            
            // Update place bet button state
            placeBetBtn.disabled = !(selectedWordCount > 0 && currentStake > 0 && currentStake <= balance);
        }

        // ==============================
        // INITIALIZATION
        // ==============================
        async function init() {
            // Check authentication state
            await checkAuthState();
        }

        // Start the application
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>